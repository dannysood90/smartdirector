<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SmartDirector©</title>
  <meta
  name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
/>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.4;
      color: #0a0a0a;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f4f5f7;
      display: flex;
      justify-content: center;
    }

    .container {
      max-width: 800px;
      width: 100%;
      padding: 24px 16px 32px;
    }

    .card {
      background: #ffffff;
      border-radius: 20px;
      padding: 24px 20px 20px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
    }

    h1 {
      font-size: 1.7rem;
      margin-top: 0;
      margin-bottom: 0.3rem;
    }

    .subtitle {
      margin-top: 0;
      margin-bottom: 1.25rem;
      color: #596172;
      font-size: 0.95rem;
    }

    .controls-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 0.75rem;
    }

    .muted {
      font-size: 0.8rem;
      color: #8b94a7;
    }

    .reset-btn {
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid #d0d5dd;
      background: #f9fafb;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .reset-btn:hover {
      background: #eef2f7;
    }

    /* SECTION CARDS (Item / Company / Personal) */

    .section-card {
      background: #f9fafb;
      border-radius: 16px;
      padding: 14px 14px 12px;
      margin-bottom: 12px;
      border: 1px solid #e1e6ee;
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: #111827;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px 16px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.9rem;
    }

    label {
      font-weight: 600;
      color: #333;
    }

    input[type="number"],
    select {
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid #ccd0d5;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      background: #ffffff;
    }

    input[type="number"]:focus,
    select:focus {
      border-color: #17803b;
      box-shadow: 0 0 0 2px rgba(23, 128, 59, 0.15);
    }

    .info-inline {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .inline-input {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .inline-input span {
      font-size: 0.9rem;
      color: #4b5563;
    }

    /* iOS-style switch for VAT – WIDER VERSION */

    .switch-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }

    .switch-label {
      font-size: 0.78rem;
      font-style: italic;
      color: #6b7280;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 90px;
      height: 28px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 2px;
      left: 2px;
      right: 2px;
      bottom: 2px;
      background-color: #e5e7eb;
      transition: 0.2s;
      border-radius: 999px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 25px;
      width: 25px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: 0.2s;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.25);
    }

    .switch input:checked + .slider {
      background-color: #15803d;
    }

    .switch input:checked + .slider:before {
      transform: translateX(22px);
    }

    /* Segmented control for Dividends / Salary */

    .segmented {
      display: flex;
      width: 100%;
      padding: 2px;
      border-radius: 999px;
      background: #e5e7eb;
      margin-top: 4px;
    }

    .segmented button {
      flex: 1 1 0;
      border: none;
      background: transparent;
      padding: 6px 0;
      border-radius: 999px;
      font-size: 0.85rem;
      cursor: pointer;
      color: #4b5563;
      text-align: center;
    }

    .segmented button.active {
      background: #15803d;
      color: #ffffff;
      font-weight: 600;
    }

    /* ACTION BUTTONS */

    .actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 16px;
      margin-bottom: 8px;
    }

    .primary-btn {
      background: #15803d;
      color: #ffffff;
      border-color: #15803d;
    }

    .primary-btn:hover {
      background: #166534;
    }

    /* RESULTS */

    .results-summary {
      margin-top: 6px;
      margin-bottom: 0.75rem;
      font-size: 0.95rem;
      font-weight: 600;
      color: #15803d;
    }

    .results-summary.negative {
      color: #b3261e;
    }

    .warning {
      margin-top: 0.25rem;
      font-size: 0.8rem;
      color: #b3261e;
    }

    .results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .result-card {
      padding: 14px;
      border-radius: 14px;
      background: #f8fafc;
      border: 1px solid #e1e6ee;
    }

    .result-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .result-value {
      font-size: 1.35rem;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .result-sub {
      font-size: 0.83rem;
      color: #4b5563;
    }

    .saving-positive {
      color: #15803d;
    }

    .saving-negative {
      color: #b3261e;
    }

    .disclaimer {
      margin-top: 16px;
      font-size: 0.75rem;
      color: #6b7280;
    }

    @media (max-width: 600px) {
      .card {
        padding: 18px 14px 16px;
        border-radius: 18px;
      }
      .grid {
        gap: 10px 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Purchase Tax Advantage Calculator</h1>
      <p class="subtitle">
        Compare making a purchase through your company versus paying for it personally from your take-home income.
      </p>

      <div class="controls-header">
        <span class="muted">Adjust the assumptions to match your situation.</span>
        <button class="reset-btn" type="button" id="resetBtn">Reset to defaults</button>
      </div>

      <!-- Purchase details -->
      <div class="section-card">
        <div class="section-title">Purchase Details</div>
        <div class="grid">
          <div class="field">
            <label for="price">Item Price</label>
            <input id="price" type="number" min="0" step="0.01" value="1000" />
            <span class="info-inline">
              Enter the total cost of the item.
            </span>
          </div>

          <div class="field">
            <label for="vatRate">VAT</label>
            <select id="vatRate">
              <option value="0.20" selected>20% (standard)</option>
              <option value="0.05">5%</option>
              <option value="0.00">0% (zero-rated)</option>
            </select>

            <div class="switch-row">
              <label class="switch">
                <input type="checkbox" id="vatOn" checked />
                <span class="slider"></span>
              </label>
              <span class="switch-label">
                VAT applies and is included in the price you entered, AND your company can reclaim it.
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Company Details -->
      <div class="section-card">
        <div class="section-title">Company Details</div>
        <div class="grid">
          <div class="field">
            <label for="corpProfit">Annual Profits</label>
            <input id="corpProfit" type="number" min="0" step="1000" value="50000" />
            <span class="info-inline">
              Before Corporation Tax, for this financial year.
              The calculator uses:
              &lt;= £50,000 → about 19%,
              &gt;= £250,000 → about 25%,
              and blends between these.
            </span>
          </div>

          <div class="field">
            <label for="corpTaxRate">Corporation Tax Rate</label>
            <div class="inline-input">
              <input id="corpTaxRate" type="number" min="10" max="30" step="0.1" value="19.0" />
              <span>%</span>
            </div>
            <span class="info-inline">
              This is the effective rate based on your profits. Change this if your accountant has given you a different figure.
            </span>
          </div>
        </div>
      </div>

      <!-- Personal tax -->
      <div class="section-card">
        <div class="section-title">Personal Tax Details</div>
        <div class="grid">
          <div class="field">
            <label>How would you pay yourself?</label>

            <!-- Segmented control visible to the user -->
            <div class="segmented" id="extractionSegment">
              <button type="button" data-value="dividend" class="active">Dividends</button>
              <button type="button" data-value="salary">Salary</button>
            </div>

            <!-- Original select kept for JS, but hidden -->
            <select id="extractionType" style="display:none;">
              <option value="dividend" selected>Dividends</option>
              <option value="salary">Salary</option>
            </select>
          </div>

          <div class="field">
            <label for="personalTaxRate">Tax rate</label>
            <select id="personalTaxRate"></select>
            <span class="info-inline">
              Your marginal tax rate on the dividends/salary used for this purchase.
            </span>
          </div>

          <div class="field" id="employeeNiField">
            <label for="employeeNiRate">Employee NI rate</label>
            <select id="employeeNiRate">
              <option value="0.08" selected>8% (between £12,570 and £50,270)</option>
              <option value="0.02">2% (over £50,270)</option>
            </select>
            <span class="info-inline">
              Select 8% unless your total salary (not dividends) is over £50,270.
            </span>
          </div>
        </div>
      </div>

      <!-- Results summary + cards -->
      <div id="resultsSummary" class="results-summary" style="display:none;"></div>
      <div id="warningText" class="warning" style="display:none;"></div>

      <div class="results">
        <div class="result-card">
          <div class="result-title">If the company buys it</div>
          <div class="result-value" id="companyCost">£–</div>
          <div class="result-sub" id="companyDetails"></div>
        </div>

        <div class="result-card">
          <div class="result-title">Overall cost if you buy it personally</div>
          <div class="result-value" id="personalTotal">£–</div>
          <div class="result-sub" id="personalBreakdown"></div>
        </div>

        <div class="result-card">
          <div class="result-title">Saving by using the company</div>
          <div class="result-value" id="savingAmount">£–</div>
          <div class="result-sub" id="savingDetails"></div>
        </div>
      </div>

      <!-- Actions: Save / Share / History -->
      <div class="actions-row">
        <button id="saveScenarioBtn" type="button" class="reset-btn primary-btn">
          Save scenario
        </button>
        <button id="shareScenarioBtn" type="button" class="reset-btn">
          Share results
        </button>
        <button id="historyBtn" type="button" class="reset-btn">
          History
        </button>
      </div>

      <!-- Saved scenarios section -->
      <div class="section-card" id="savedScenariosSection" style="display:none; margin-top: 8px;">
        <div class="section-title">Saved scenarios</div>
        <div id="savedScenariosList" class="info-inline">
          <!-- Filled by JS -->
        </div>
      </div>

      <p class="disclaimer">
        This is a simplified calculator based on marginal UK tax and NI rates. It does not account for all edge cases
        (allowances, thresholds, benefits, etc.) and is for illustration only. It is not tax advice. Please speak to
        your accountant or tax adviser before making decisions.
      </p>
    </div>
  </div>

  <script>
    // Employer NI (standard Class 1 secondary rate)
    const EMPLOYER_NI_RATE = 0.138;  // 13.8% employer Class 1

    const dividendRates = [
      { value: 0.0875, label: "8.75% (basic-rate dividends)" },
      { value: 0.3375, label: "33.75% (higher-rate dividends)" },
      { value: 0.3935, label: "39.35% (additional-rate dividends)" }
    ];

    const salaryRates = [
      { value: 0.20, label: "20% (basic-rate salary)" },
      { value: 0.40, label: "40% (higher-rate salary)" },
      { value: 0.45, label: "45% (additional-rate salary)" }
    ];

    const STORAGE_KEY = "smartDirectorScenariosV1";

    // Simple approximation of effective Corporation Tax rate based on profit.
    // Uses 19% up to £50k, 25% from £250k, and linearly blends between.
    const CT_LOWER_PROFIT = 50000;
    const CT_UPPER_PROFIT = 250000;
    const CT_RATE_LOW = 0.19;
    const CT_RATE_HIGH = 0.25;

    function effectiveCorpRateFromProfit(profit) {
      if (!isFinite(profit) || profit <= 0) return CT_RATE_LOW;
      if (profit <= CT_LOWER_PROFIT) return CT_RATE_LOW;
      if (profit >= CT_UPPER_PROFIT) return CT_RATE_HIGH;
      const t = (profit - CT_LOWER_PROFIT) / (CT_UPPER_PROFIT - CT_LOWER_PROFIT);
      return CT_RATE_LOW + t * (CT_RATE_HIGH - CT_RATE_LOW);
    }

    function estimateProfitFromRate(ratePercent) {
      const r = ratePercent / 100;
      if (!isFinite(r) || r <= 0) return CT_LOWER_PROFIT;
      if (r <= CT_RATE_LOW) return CT_LOWER_PROFIT;
      if (r >= CT_RATE_HIGH) return CT_UPPER_PROFIT;
      const t = (r - CT_RATE_LOW) / (CT_RATE_HIGH - CT_RATE_LOW);
      return CT_LOWER_PROFIT + t * (CT_UPPER_PROFIT - CT_UPPER_PROFIT / CT_UPPER_PROFIT + (CT_UPPER_PROFIT - CT_LOWER_PROFIT) * t);
    }

    // Slight correction: simpler mapping back from rate to profit
    function estimateProfitFromRate(ratePercent) {
      const r = ratePercent / 100;
      if (!isFinite(r) || r <= 0) return CT_LOWER_PROFIT;
      if (r <= CT_RATE_LOW) return CT_LOWER_PROFIT;
      if (r >= CT_RATE_HIGH) return CT_UPPER_PROFIT;
      const t = (r - CT_RATE_LOW) / (CT_RATE_HIGH - CT_RATE_LOW);
      return CT_LOWER_PROFIT + t * (CT_UPPER_PROFIT - CT_LOWER_PROFIT);
    }

    function formatMoney(value) {
      if (!isFinite(value)) return "£–";
      return "£" + value.toFixed(2);
    }

    function formatPercent(value) {
      if (!isFinite(value)) return "–%";
      return (value * 100).toFixed(1) + "%";
    }

    function populatePersonalTaxRates(extractionType) {
      const select = document.getElementById("personalTaxRate");
      select.innerHTML = ""; // clear existing options

      const rates = extractionType === "dividend" ? dividendRates : salaryRates;

      rates.forEach((rate, index) => {
        const opt = document.createElement("option");
        opt.value = rate.value;
        opt.textContent = rate.label;

        // Default selection
        if (extractionType === "salary" && index === 0) {
          opt.selected = true; // 20% salary
        }
        if (extractionType === "dividend" && index === 1) {
          opt.selected = true; // 33.75% dividends
        }

        select.appendChild(opt);
      });
    }

    function updateNiVisibility(extractionType) {
      const niField = document.getElementById("employeeNiField");
      if (extractionType === "salary") {
        niField.style.display = "flex";
      } else {
        niField.style.display = "none";
      }
    }

    let isSyncingCorp = false;

    function updateCorpRateFromProfit() {
      if (isSyncingCorp) return;
      isSyncingCorp = true;
      const profit = parseFloat(document.getElementById("corpProfit").value) || 0;
      const rate = effectiveCorpRateFromProfit(profit) * 100;
      document.getElementById("corpTaxRate").value = rate.toFixed(1);
      calculate();
      isSyncingCorp = false;
    }

    function updateProfitFromCorpRate() {
      if (isSyncingCorp) return;
      isSyncingCorp = true;
      const ratePercent = parseFloat(document.getElementById("corpTaxRate").value) || (CT_RATE_LOW * 100);
      const estProfit = estimateProfitFromRate(ratePercent);
      document.getElementById("corpProfit").value = Math.round(estProfit / 1000) * 1000; // round to nearest £1k
      calculate();
      isSyncingCorp = false;
    }

    function setDefaults() {
      document.getElementById("price").value = 1000;
      document.getElementById("corpProfit").value = 50000;
      document.getElementById("corpTaxRate").value = (CT_RATE_LOW * 100).toFixed(1);
      document.getElementById("vatRate").value = "0.20";
      document.getElementById("vatOn").checked = true;
      document.getElementById("extractionType").value = "dividend";
      populatePersonalTaxRates("dividend");
      document.getElementById("employeeNiRate").value = "0.08";
      updateNiVisibility("dividend");
      updateExtractionSegment("dividend");
    }

    function calculate() {
      const priceInput = parseFloat(document.getElementById("price").value) || 0;
      const corpTaxRate = (parseFloat(document.getElementById("corpTaxRate").value) || 0) / 100;
      const vatOn = document.getElementById("vatOn").checked;
      const vatRate = parseFloat(document.getElementById("vatRate").value) || 0;
      const extractionType = document.getElementById("extractionType").value;
      const personalTaxRate = parseFloat(document.getElementById("personalTaxRate").value) || 0;
      const employeeNiRate = extractionType === "salary"
        ? parseFloat(document.getElementById("employeeNiRate").value) || 0
        : 0;

      // COMPANY COST:
      let netPrice;
      let grossPriceForPersonal = priceInput;

      if (vatOn && vatRate > 0) {
        netPrice = priceInput / (1 + vatRate);
      } else {
        netPrice = priceInput;
      }

      const companyCost = netPrice * (1 - corpTaxRate);

      // PERSONAL ROUTE:
      const personalSpend = grossPriceForPersonal;

      let personalCost;
      let warningText = "";
      let breakdownText = "";

      if (extractionType === "dividend") {
        const denom = (1 - corpTaxRate) * (1 - personalTaxRate);
        if (denom <= 0.05) {
          warningText =
            "Your selected Corporation Tax and dividend tax rates make personal extraction extremely inefficient. " +
            "Check that the rates reflect your real marginal position.";
        }
        personalCost = denom > 0 ? personalSpend / denom : Infinity;

        if (denom > 0 && isFinite(personalCost)) {
          const preTaxProfit = personalCost; // by construction
          const corpTax = preTaxProfit * corpTaxRate;
          const postTaxProfit = preTaxProfit - corpTax;
          const grossDividend = postTaxProfit;
          const dividendTax = grossDividend * personalTaxRate;

          breakdownText =
            `Includes ${formatMoney(corpTax)} in Corporation Tax and ` +
            `${formatMoney(dividendTax)} in dividend tax `;
        }
      } else {
        const denom = 1 - personalTaxRate - employeeNiRate;
        if (denom <= 0.05) {
          warningText =
            "With this combination of income tax and NI, taking extra salary is extremely inefficient. " +
            "Consider whether dividends or a different structure is more realistic.";
        }
        personalCost = denom > 0 ? personalSpend * (1 + EMPLOYER_NI_RATE) / denom : Infinity;

        if (denom > 0 && isFinite(personalCost)) {
          const grossSalary = personalSpend / denom;
          const incomeTax = grossSalary * personalTaxRate;
          const employeeNI = grossSalary * employeeNiRate;
          const employerNI = grossSalary * EMPLOYER_NI_RATE;

          breakdownText =
            `Includes ${formatMoney(incomeTax)} in income tax, ` +
            `${formatMoney(employeeNI)} in employee NI and ` +
            `${formatMoney(employerNI)} in employer NI to leave you with `;
        }
      }

      const saving = personalCost - companyCost;
      const savingPercent = personalCost > 0 ? saving / personalCost : 0;

      const companyCostEl = document.getElementById("companyCost");
      const companyDetailsEl = document.getElementById("companyDetails");
      const personalTotalEl = document.getElementById("personalTotal");
      const personalBreakdownEl = document.getElementById("personalBreakdown");
      const savingAmountEl = document.getElementById("savingAmount");
      const savingDetailsEl = document.getElementById("savingDetails");
      const resultsSummaryEl = document.getElementById("resultsSummary");
      const warningEl = document.getElementById("warningText");

      companyCostEl.textContent = formatMoney(companyCost);

      let vatText;
      if (vatOn && vatRate > 0) {
        vatText =
          `Assumes the price you entered includes VAT at ${formatPercent(vatRate)}, which your company reclaims. `;
      } else if (vatRate > 0) {
        vatText =
          `VAT is not reclaimed (either not applicable or not claimed). `;
      } else {
        vatText = "No VAT reclaimed or VAT not applicable. ";
      }
      let corpText = `Corporation Tax relief at ${formatPercent(corpTaxRate)} on the net cost.`;

      companyDetailsEl.textContent = vatText + corpText;

      personalTotalEl.textContent = formatMoney(personalCost);
      personalBreakdownEl.textContent = breakdownText || "";

      savingAmountEl.textContent = formatMoney(saving);
      savingAmountEl.classList.remove("saving-positive", "saving-negative");
      resultsSummaryEl.classList.remove("negative");
      resultsSummaryEl.style.display = "block";

      if (saving > 0.005) {
        savingAmountEl.classList.add("saving-positive");
        savingDetailsEl.textContent =
          `Using the company is cheaper by ${formatMoney(saving)} ` +
          `(${(savingPercent * 100).toFixed(1)}% of the overall cost if you buy it personally).`;
        resultsSummaryEl.textContent =
          `Using your limited company saves you ${formatMoney(saving)} on this purchase.`;
      } else if (saving < -0.005) {
        savingAmountEl.classList.add("saving-negative");
        savingDetailsEl.textContent =
          `Using the company is more expensive by ${formatMoney(-saving)} ` +
          `(${(Math.abs(savingPercent) * 100).toFixed(1)}% more than buying personally).`;
        resultsSummaryEl.textContent =
          `In this scenario, buying personally is cheaper by ${formatMoney(-saving)}.`;
        resultsSummaryEl.classList.add("negative");
      } else {
        savingDetailsEl.textContent = "No meaningful difference between the two options.";
        resultsSummaryEl.textContent =
          "There’s very little difference between company and personal in this scenario.";
      }

      if (warningText) {
        warningEl.textContent = warningText;
        warningEl.style.display = "block";
      } else {
        warningEl.style.display = "none";
      }
    }

    // --- Segmented control for extraction type (dividends / salary) ---

    function updateExtractionSegment(value) {
      const buttons = document.querySelectorAll("#extractionSegment button");
      buttons.forEach(btn => {
        btn.classList.toggle("active", btn.dataset.value === value);
      });
    }

    document.querySelectorAll("#extractionSegment button").forEach(btn => {
      btn.addEventListener("click", () => {
        const value = btn.dataset.value;
        const select = document.getElementById("extractionType");
        select.value = value;

        populatePersonalTaxRates(value);
        updateNiVisibility(value);
        updateExtractionSegment(value);
        calculate();
      });
    });

    // --- Scenario saving / history / sharing ---

    function getCurrentScenario() {
      return {
        id: Date.now(),
        name: "",
        createdAt: new Date().toISOString(),
        inputs: {
          price: document.getElementById("price").value,
          corpProfit: document.getElementById("corpProfit").value,
          corpTaxRate: document.getElementById("corpTaxRate").value,
          vatRate: document.getElementById("vatRate").value,
          vatOn: document.getElementById("vatOn").checked,
          extractionType: document.getElementById("extractionType").value,
          personalTaxRate: document.getElementById("personalTaxRate").value,
          employeeNiRate: document.getElementById("employeeNiRate").value,
        },
        outputs: {
          companyCost: document.getElementById("companyCost").textContent,
          personalTotal: document.getElementById("personalTotal").textContent,
          savingAmount: document.getElementById("savingAmount").textContent,
          savingDetails: document.getElementById("savingDetails").textContent,
        }
      };
    }

    function loadScenarios() {
      const raw = localStorage.getItem(STORAGE_KEY);
      try {
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function saveScenarios(list) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    function renderSavedScenarios() {
      const list = loadScenarios();
      const section = document.getElementById("savedScenariosSection");
      const container = document.getElementById("savedScenariosList");

      if (!list.length) {
        section.style.display = "none";
        container.innerHTML = "";
        return;
      }

      section.style.display = "block";
      container.innerHTML = "";

      list
        .sort((a, b) => b.id - a.id) // newest first
        .forEach((scenario, index) => {
          const wrapper = document.createElement("div");
          wrapper.style.marginBottom = "10px";
          wrapper.style.paddingBottom = "8px";
          wrapper.style.borderBottom = "1px solid #e5e7eb";

          const title = document.createElement("div");
          title.style.fontWeight = "600";
          title.style.fontSize = "0.85rem";
          title.textContent = scenario.name || `Scenario ${index + 1}`;

          const details = document.createElement("div");
          details.style.fontSize = "0.8rem";
          details.style.marginTop = "2px";
          details.textContent =
            `${scenario.outputs.savingAmount} saving vs ${scenario.outputs.personalTotal} personal cost`;

          const buttonsRow = document.createElement("div");
          buttonsRow.style.marginTop = "4px";
          buttonsRow.style.display = "flex";
          buttonsRow.style.gap = "6px";

          const loadBtn = document.createElement("button");
          loadBtn.textContent = "Load";
          loadBtn.type = "button";
          loadBtn.className = "reset-btn";
          loadBtn.style.fontSize = "0.75rem";
          loadBtn.onclick = () => restoreScenario(scenario);

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "Delete";
          deleteBtn.type = "button";
          deleteBtn.className = "reset-btn";
          deleteBtn.style.fontSize = "0.75rem";
          deleteBtn.onclick = () => deleteScenario(scenario.id);

          buttonsRow.appendChild(loadBtn);
          buttonsRow.appendChild(deleteBtn);

          wrapper.appendChild(title);
          wrapper.appendChild(details);
          wrapper.appendChild(buttonsRow);

          container.appendChild(wrapper);
        });
    }

    function restoreScenario(scenario) {
      const i = scenario.inputs;

      document.getElementById("price").value = i.price;
      document.getElementById("corpProfit").value = i.corpProfit;
      document.getElementById("corpTaxRate").value = i.corpTaxRate;
      document.getElementById("vatRate").value = i.vatRate;
      document.getElementById("vatOn").checked = i.vatOn;

      document.getElementById("extractionType").value = i.extractionType;
      populatePersonalTaxRates(i.extractionType);
      updateNiVisibility(i.extractionType);
      updateExtractionSegment(i.extractionType);

      // Set personal tax rate if it matches one of the options
      const ptrSelect = document.getElementById("personalTaxRate");
      const ptrVal = i.personalTaxRate;
      const option = Array.from(ptrSelect.options).find(o => o.value === String(ptrVal));
      if (option) {
        ptrSelect.value = ptrVal;
      }

      document.getElementById("employeeNiRate").value = i.employeeNiRate;

      calculate();

      // Scroll back to top of card so user sees the numbers
      document.querySelector(".card").scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function deleteScenario(id) {
      const list = loadScenarios().filter(s => s.id !== id);
      saveScenarios(list);
      renderSavedScenarios();
    }

    function saveCurrentScenario() {
      const scenario = getCurrentScenario();
      const defaultName = `Purchase £${document.getElementById("price").value || "0"}`;
      const name = prompt("Give this scenario a name (e.g. “MacBook Pro”):", defaultName);
      if (!name) return;
      scenario.name = name.trim();

      const list = loadScenarios();
      list.push(scenario);
      saveScenarios(list);
      renderSavedScenarios();
      alert("Scenario saved.");
    }

    function shareScenario() {
      const price = document.getElementById("price").value || "0";
      const companyCost = document.getElementById("companyCost").textContent || "–";
      const personalTotal = document.getElementById("personalTotal").textContent || "–";
      const savingAmount = document.getElementById("savingAmount").textContent || "–";
      const savingDetails = document.getElementById("savingDetails").textContent || "";

      const text = `
SmartDirector – Purchase scenario

Item price: £${price}
If company buys it: ${companyCost}
If you buy personally: ${personalTotal}
Saving by using the company: ${savingAmount}

${savingDetails}
      `.trim();

      if (navigator.share) {
        navigator.share({
          title: "SmartDirector scenario",
          text
        }).catch(() => {
          // ignored if user cancels
        });
      } else if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          alert("Scenario summary copied to clipboard.");
        }).catch(() => {
          alert("Could not copy to clipboard on this device.");
        });
      } else {
        alert("Sharing is not supported on this device.");
      }
    }

    function showHistory() {
      renderSavedScenarios();
      const section = document.getElementById("savedScenariosSection");
      if (section.style.display !== "none") {
        section.scrollIntoView({ behavior: "smooth", block: "start" });
      } else {
        alert("No saved scenarios yet.");
      }
    }

    // Recalculate whenever inputs change
    document.querySelectorAll(
      "#price, #vatOn, #vatRate, #extractionType, #personalTaxRate, #employeeNiRate"
    ).forEach(el => {
      el.addEventListener("input", calculate);
      el.addEventListener("change", calculate);
    });

    // VAT toggle
    document.getElementById("vatOn").addEventListener("change", (e) => {
      document.getElementById("vatRate").disabled = !e.target.checked;
      calculate();
    });

    // Profit / CT rate sync
    document.getElementById("corpProfit").addEventListener("input", updateCorpRateFromProfit);
    document.getElementById("corpTaxRate").addEventListener("input", updateProfitFromCorpRate);

    // Action buttons
    document.getElementById("saveScenarioBtn").addEventListener("click", saveCurrentScenario);
    document.getElementById("shareScenarioBtn").addEventListener("click", shareScenario);
    document.getElementById("historyBtn").addEventListener("click", showHistory);

    // Reset button
    document.getElementById("resetBtn").addEventListener("click", () => {
      setDefaults();
      updateCorpRateFromProfit();
    });

    // Initial setup
    setDefaults();
    updateCorpRateFromProfit();
    renderSavedScenarios();
  </script>
</body>
</html>
